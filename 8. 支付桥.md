支付桥{.text-center}
---------

&nbsp;

### 支付桥的功能

在 NBC 技术体系中，DID 与 PAY 是并列的两个子系统，前者主要用在身份角色的登录与授权上，后者 PAY 子系统则服务于数字货币支付。显然，后者安全性要求更高，我们建议用户配置专业加密芯片来保障支付安全。

DID 子系统与 PAY 子系统的交汇点就是支付桥，支付桥驻留在 Service Worker 进程中，它主要负责建立并维持 SW 与支付芯片之间的消息联系。

一种典型组网如下图，支付芯片（图中标为 chip）与 SW 之间存在消息通道，在 web 页发起的支付请求通过 NAL 接口调用，经支付桥向本设备中的 chip 部件发起，chip 对支付相关的特定待验消息（或消息哈希值）签名，返回签名字串。

```
  +------------------------+
  | Client Device          |
  |                        |
  | +---------+   +-----+  |
  | | Service |   |     |  |  +----------+
  | | Worker  +---+ web +--+--+ realname |
  | |  (NAL)  |   |     |  |  |  server  |
  | +----+----+   +-----+  |  +----------+
  |      |                 |
  |   +--+---+             |
  |   | chip |             |
  |   +------+             |
  +------------------------+
```

chip 部件还可以拉远，布署到其它机器，如下图：

```
  +------------------------+
  | Client Device          |
  | +---------+   +-----+  |
  | | Service |   |     |  |  +----------+
  | | Worker  +---+ web +--+--+ realname |
  | |  (NAL)  |   |     |  |  |  server  |
  | +----+----+   +-----+  |  +----------+
  |      |                 |
  +------+-----------------+
         |
  +------+-----------------+
  |      |  Trusted Device |
  |    +-+----------+      |
  |    | Web Server |      |
  |    +------------+      |
  |    +------------+      |
  |    |    TEE     |      |
  |    +------------+      |
  +------------------------+
```

NBC DID 可以独立运用，并不依赖于 NBC PAY。SW 中的支付桥缺省未打开，如果我们不去配置，NBC PAY 子系统将不启用。

&nbsp;

### 发起支付的安全保证

前面我们已介绍授权验证方式有 4 种，即 `pass, rsvd, pay, auto`，其中 pay 验证还没介绍。

pay 验证的安全级别高于 pass 验证与 rsvd 验证，支付若出问题将直接导致钱财损失，NBC 生态强调要由安全加密芯片确保支付安全，还因为本体系是开放体系，不能借助闭源开发方式实现安全。加密芯片中驻留 `PAY-ACC` 账号，在芯片中该账号对特定待验消息实施签名，签名结果可以用 `PAY-ACC` 的公钥在芯片外验证，这种签名并验证的过程就是 pay 验证。实施签名永远只在安全芯片内进行，`PAY-ACC` 私钥永不流出芯片。

NBC PAY 系统还要求 pay 验证在 pass 验证基础上进行，即，pay 验证将叠加 pass 验证，SW 向 chip 部件发起 pay 验证请求前，需先通过 pass 验证，然后请求消息才会转发。另外，为提高安全性，我们还要求 chip 部件至少支持一项第 2 因子验证，验证方式可有多种选择，比如：指纹识别、chip 内置物理按键等。

需补充说明的是，pay 验证的用途并不限于支付，它作为一种验证手段，凡有高安全需求的场合都可采用。这类似于在微信中，官方程序有时要求用户输入支付密码，来确认当前操作者是账号所有者本人，并非纯粹只用作支付。
