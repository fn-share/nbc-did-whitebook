多维度二次验证 {: .text-center }
------------

&nbsp;

### 权威机构不再公正怎么办？

在签证换发绿卡环节，如果设立通密服务点的权威机构不再公正了怎么办？最优解是改换到由区块链，由公链中的挖矿节点提供服务。

不过，本系统仍有若干措施促使权威机构持续保持公正。其一，真身服务点能提供证据事后验证换发的绿卡是否作弊；其二，借助其它沟通渠道，比如手机短信、邮件等，可在侧面验证活跃使用中的绿卡是不是滥发了。这些属于多维度二次验证的范畴，能起到事后监督的作用。

&nbsp;

### 验根码验证

用户用签证换发绿卡时，会先向真身服务点申请一个隐身份护照，授权目标的 child1 作为参数一起提交，然后服务点为该用户随机生成一个近期未用的 child2 值，用 `alt/0/0/child1/child2` 推导一个隐身份，封装成护照格式返回给用户。

隐护照中的验根码 rootcode 是一种简便的同属关系证明，其值与隐身份的父账号，也就是签证中的被授权目标账号，以及衍生序号 child2 相关。当应用网站想验证用户登录的绿卡是否伪造时，可以向真身服务点发请求，询问近期启用的隐身份中是否有绿卡属主，若有，就返回隐身份对应的 rootcode 值，询问者自行检查此 rootcode 与绿卡中的记录是否一致，若一致，就大概率证明这份绿卡没有伪造。

应用网站管理员与普通用户，都可以向真身服务点查询指定隐身份的验根码。验根码能证明隐身份是否真实、是否仍旧活跃（即，未过期），网站管理员与普通用户都会用到。

这里，我们要区分一种情况，用户将自身账号授权给许多人是合法的，不算滥用。应用网站若想防止用户过多转授权，只需在登录环节增加条件限制，比方限制与同一资源关联的多个身份同时登录。但如果遇到未授权也能获得可用绿卡，则属安全事故，账号被非法用户入侵了，本体系要严格防范这类事故。

&nbsp;

### 更严格的同属验证

如果一个应用网站很强调安全性，而它依赖的通密服务点 Crypto Server Point 由中心化机构提供，就有必要采取更严格的验证方法：预留校验的同属验证。如果通密服务点由区块链提供，不用此法也是安全的。

首先，应用网站事先要到真身服务点注册一个管理员身份，同时管理员还在真身服务点设置一个预留字 reserved_word。

此后，应用网站每次颁发签证之前，都向真身服务点提交 “指定泛身份正在我站使用” 的声明，泛身份就是签证中的被授权对象。

当用户持绿卡登录网站时，网站管理员将向真身服务点请求 “预留校验的同属验证”，服务点返回下述 full_hash 与 extra_code，算法如下：

``` python
full_hash = sha256(generic_acc.publicKey() + b':' + child2)
extra_code = ripemd_hash(full_hash + b':' + reserved_word)
```

其中，generic_acc 是真身服务点通过输入绿卡属主查表得到的父级泛护照身份，对应的推导路径 child2 也由查表得到。full_hash 是同属证明的证据，它的前 4 字节就是 rootcode，extra_code 则将 full_hash 结合预留字再计算 hash 值。网站验证同属关系时，除了比较 rootcode 外，还自行推算 extra_code 取值，看看是否与真身服务点提供的一致，若不一致，说明当前绿卡是伪造的。

因为预留字只有真身服务点与应用网站自己知道，非授权对象的泛身份无法在真身服务点标记  “指定泛身份正在某站使用”，真身服务点无法提供上述 extra_code 信息，而他人想伪造 extra_code，因为不知道预留字，无从伪造。

补充说明：由通密服务点提供的签证换护照，正常应由公链提供服务，如果由某个中心化机构提供，建议只在受限制场景中使用。比方，限在调测或试运营阶段使用，集团用户限在本机构内使用特定软件，在特定的、政策敏感的 app 中使用等。

特别说明：同一个中心化机构不应同时提供真身服务点与通密服务点，如果同时提供，他的通密服务点只能用于调测场合，不能用于正式产品运营。

&nbsp;

### 提供同属验证的完全证据

上面提到的基于验根码的同属验证，其实不算完全验证，因为证据是 hash 值，而不是计算 hash 值的源头参数，若缺源头参数他人仍无从推导。

特定情况下，比方起纠纷进入仲裁流程，或进入司法程序了，真身服务点需提供推导 hash 值证据的源头参数。即，上述计算 full_hash 所需的 `generic_acc.publicKey()` 与 `child2` 取值，然后相关人能自行按常规衍生的方法，推导出身份若与绿卡属主匹配，就完全证明两者同属。

因为完全证据验证会泄露签证与绿卡之间的关联关系，所以，真身服务点不会对外界提供这样的 API 服务。

在本节介绍的基于验根码的同属关系二次验证有点繁琐，如果改用公链颁发绿卡，会省掉许多麻烦。本质上说，麻烦是因为通密服务点没有消除中心化控制而导致，天然存在不足。若改由公链中的挖矿节点换发绿卡，隐身份将不必通过真身服务点生成，依据验根码的同属验证也变简单，区块链有一套保证绿卡不被伪造的机制。
