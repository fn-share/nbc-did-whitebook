授权与转授权原理 { .text-center }
---------------------

&nbsp;

### 授权本质是对资源使用权的调配

应用网站如果不给用户提供资源服务，就不需要设计授权机制。凡为用户提供服务关系到资源成本，而且成本没有低到允许免费的程度，网站服务商就应该规划资源类别、使用条件、授权方式等课题。

就一般意义上，也是较为简便的方法，我们建议服务商取用户的可公开真身标识作为资源的识别依据，比如用 `disk:<user_real_id>` 标识分配给用户的网盘资源，用 `gpu:<user_real_id>` 标识分配给用户的 GPU 算力资源。即，将网站所有服务理解成资源，把所有资源规范化分类管理，以 `<resource_type>:<user_real_id>` 前缀加用户真身标识的方式唯一标识资源的成本单元。

资源的使用条件由用户需求、成本要素、商业模型等因素决定。比方，网站不希望他提供的资源被滥用，可能要限制同一账号（一般以用户可公开真身标识为 ID）同时登录的人数，当用户能自由的将自身权益授权给他人，容易造成多人同时登录使用同一资源的现象。同一账号限制同时使用人数，只需在登录 session 控制施加限制，比如超过限定人数就拒绝新的登录申请，又比如，同一时间仅限一人使用，可以让后来登录者挤掉前面登录者，或者，前面若有人已登录且未退出，就拒绝后人登录。

资源的使用条件可以很复杂，比如结合登录者角色（如管理员身份、读者身份等）做不同控制；再比如结合时间，授权 A 只能在周一使用，B 只能在周二使用，等等。

资源使用条件在签证的 session_data 字段体现，后文详述。资源授权方式也在 session_data 体现，使用条件与授权方式都是一次登录事务的参数项，两者主要不同是，资源使用条件是前置判断，条件满足就允许登录，否则拒绝，而资源授权方式是资源使用过程中的控制参数 。

&nbsp;

### 标记资源使用权

签证中还有一个 realm 字段，记录当前登录者所处的上下文环境，比如，登录到哪个域（网站）、以什么角色登录等。

结合 realm、session_data 生成一个字串，再叠加登录者身份（公钥）与授权凭证生成时间，然后取其摘要（即，计算 hash 值），**所得 hash 就能标记当次登录的资源使用权了**。此后网站对相关资源使用权的验证，从编程角度理解，就是如何让网站认可该 hash 指示物已获正确授权了 。

&nbsp;

### 网站通过内置机密验证授权

应用网站预设一个机密字串，我们记为 secret，让它与上面所说的 hash 合并，对合并后字串再计算 hash 值，得到的值即可用作 “授权凭证”。

因为 hash 摘要运算具有单向性，从输出结果难以推导输入取值，只要 secret 被安全传递给颁发绿卡的公正机构，把计算结果 hash 值（即授权凭证）写入绿卡，攻击者将很难反推得到 secret 原值，所以，这种凭证很难伪造。

如后文介绍，安全传递 secret 是通过将 secret 加密后写入签证的 seed_secret 字段实现，最终的授权凭证将写入绿卡的 login_session 字段。将资源使用权授给自己是授权，授给他人，是转授权，或者对他人开放二次授权能力，他人再授给他人，也是转授权。

现在我们总结一下上述授权及验证的实施步骤。

第一步，用户向网站申请生成一份签证，网站核实相关条件后，准许颁发签证，于是网站在待颁签证中写入若干信息，包括：申请者是谁、授权对象是谁、授予什么样的资源使用权、是否允许二次授权，然后网站对待颁签证签名以示确认。

第二步，被授权者依据刚取得的签证，向某公正机构请求颁发绿卡，公正机构对提交的签证，以及生成绿卡所需的其它参数作检验，检验通过后，接着解密 secret 取得明文，然后按照前述方法推导 “授权凭证”，把它写入待颁发的绿卡，最后，生成绿卡传递给申请者。

第三步，被授权者持绿卡登录网站，网站验证绿卡格式（检查有效期、验证签名等），验证授权凭证，若通过就准许该用户登录。
