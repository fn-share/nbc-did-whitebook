签证格式{.text-center}
------------

&nbsp;

### 签证申请流程

签证由应用网站颁发，用户需先以某个角色 role 登录应用网站，然后向网站申请创建签证。

被授权的权限需小于等于当前登录者已拥有的，即，颁发的签证不应出现扩权情况。用户请求应用网站服务器（Web Server）生成签证时，可以有选择的缩减某些权限，如果缩减权限可以用随同发出的参数指示，其中，需有一项参数指示授权目标（泛护照），还需有一项参数用来指示被授权者是否拥有二次授权能力。

如下图，请求生成签证前，用户网页应先向 Real Server Point 请求生成被授权目标用户的一份泛护照，成功后泛护照将缓存到 Service Worker 的 indexed DB。然后，用户网页向应用服务器请求生成签证，请求参数包括：刚生成的泛护照、权限配置、登录者对当前请求所作的签名。当应用服务器成功生成签证返回后，签证也将保存到 Service Worker 的 indexed DB 中。

```
     request one generic_passport
 | <------------------------------- |                         |
 | ---- reply generic_passport ---> |                         |
 |                                  |   request one visa      |
 |                                  | ----------------------> |
 |                                  | <----- reply visa ----- |
 |                                  |                         |
Real Server Point               Web Client                Web Server
```

&nbsp;

### 签证格式

签证定义如下字段：

1. account 字段  
取 33 字节长的公钥值，表达属主身份。

2. rootcode 字段  
被授权对象的验根码，4 字节长，从传入泛护照的 rootcode 字段取值。

3. target 字段  
被授权对象，取 33 字节长的公钥值，从传入泛护照的 account 字段取值。

4. realm 字段  
领域字段，最长限制 96 字节。一般填写网站域名与登录者角色，比如：`"netlog.nb-chain.cn+editor"`

5. session_data 字段  
会话配置，最长取 127 字节，表达当前角色所拥有权限的基础上叠加的权限参数。

6. admin_figerprint 字段  
管理员指纹，固定取当前应用网站管理员账号的 ripemd_hash 摘要值的前 4 字节。

7. cert_expired 字段  
证书失效时间，用 4 字节表达本证书的失效时间（以分钟为单位，按 BigEndian 格式存贮）。签证的失效时间可以离现在很久远，最长允许 20 年后失效。

8. now_time 字段  
当前时间，占用 5 字节，首字节表达 sess_type 值，后 4 字节为当前分钟值，按 BigEndian 格式存贮。

9. seed_secret 字段  
应用网站的种密，占用 48 字节，这是密文态的官方授权依据。

10. max_auth_time 字段  
凭签证换绿卡时一次授权的最大时长，占用 4 字节，以分钟为单位，按 BigEndian 格式存贮。

11. signature 字段  
签名字段，占用 64 字节，证书颁发者（即应用网站管理员）针对本证书主体内容给出的签名。

&nbsp;

### 用 realm 限定作用域

领域 realm 字段在护照、签证、绿卡中均被使用，它用于指示当前卡证的作用域。使用签证授权生成绿卡时，realm 字段被原样平移到绿卡，当用户持护照或绿卡登录应用网站时，登录者的角色与作用域将由 realm 字段限定。

realm 可由多个子段组成，各个子段以 `"+"` 串接，首段要求指定应用网站的域名，第二段要求指定当前登录者角色，第三段往后还可指定更多的、从属的范围限制。比如 `"im-buf.nb-chain.cn+manager+family"` 表达登录者在 `im-buf.nb-chain.cn` 网站按管理员身份（manager）使用 family 群组。

在尾部指定 action 操作的 realm 值，常用来指示某项授权，比如 `netlog.nb-chain.cn+editor+login` 表达登录者在 `netlog.nb-chain.cn` 网站按主编身份（editor）请求登录（login）操作，登录者对含该 realm 的字串签名，就表示他已同意本次 login 操作。附加在 realm 尾段的 action 须是当前应用网站在策略定义中已列明的某项操作。

realm 中各子段的合法取值要求是可打印的 ascii 字母，但不能取如下值：

```
  空格  <   >   =   ,   "   '   +
```

取日常所见大小写英文字母、数字、下划线、括号、叹号（`"!"`）、连接号（`"-"`）、井号（`"#"`）、at号（`"@"`）等都是可以的。
